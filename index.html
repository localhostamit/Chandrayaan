<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORBITAL COMMAND | PRO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; overflow: hidden; background: #000205; font-family: 'Segoe UI', sans-serif; }
        
        /* Glassmorphism UI */
        .glass {
            background: rgba(10, 20, 35, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* Loading Spinner */
        .loader {
            border: 2px solid #1f2937;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px; height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="text-white selection:bg-blue-500">

    <div class="absolute top-0 left-0 w-full p-4 z-20 pointer-events-none flex justify-between items-start">
        <div class="glass px-4 py-3 rounded-lg pointer-events-auto flex items-center gap-4">
            <div class="bg-blue-600 p-2 rounded text-white"><i class="fa-solid fa-globe"></i></div>
            <div>
                <h1 class="text-xl font-bold tracking-tight leading-none text-blue-100">ORBITAL<span class="text-blue-500">PRO</span></h1>
                <div class="flex items-center gap-2 text-[10px] font-mono mt-1 text-gray-400">
                    <span id="status-icon" class="loader"></span>
                    <span id="status-text">INITIALIZING SYSTEMS...</span>
                </div>
            </div>
        </div>

        <div class="glass px-4 py-2 rounded-lg text-right hidden md:block">
            <div class="text-[10px] text-blue-400 font-bold tracking-widest">UTC CLOCK</div>
            <div id="clock" class="text-2xl font-mono tabular-nums">00:00:00</div>
        </div>
    </div>

    <div id="side-panel" class="absolute top-0 right-0 h-full w-80 glass transform translate-x-full transition-transform duration-300 z-30 pointer-events-auto flex flex-col border-l border-white/10">
        <div class="p-6 border-b border-white/10 flex justify-between items-start bg-black/20">
            <div>
                <div class="text-[10px] text-blue-400 font-bold tracking-widest mb-1">SELECTED ASSET</div>
                <h2 id="panel-name" class="text-2xl font-bold leading-none break-words">SAT_NAME</h2>
                <div class="mt-2 text-xs font-mono text-gray-400">NORAD ID: <span id="panel-id" class="text-white">00000</span></div>
            </div>
            <button onclick="closePanel()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
        </div>

        <div class="p-6 flex-1 overflow-y-auto space-y-6">
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white/5 p-3 rounded">
                    <div class="text-[10px] text-gray-400 mb-1">LATITUDE</div>
                    <div id="panel-lat" class="text-lg font-mono">0.00째</div>
                </div>
                <div class="bg-white/5 p-3 rounded">
                    <div class="text-[10px] text-gray-400 mb-1">LONGITUDE</div>
                    <div id="panel-lng" class="text-lg font-mono">0.00째</div>
                </div>
            </div>

            <div class="bg-white/5 p-4 rounded border border-white/5">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs text-gray-400">ALTITUDE</span>
                    <span id="panel-alt" class="text-xl font-bold text-blue-400 font-mono">0 km</span>
                </div>
                <div class="h-1.5 w-full bg-gray-700 rounded-full overflow-hidden">
                    <div id="alt-bar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
                </div>
                <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                    <span>LEO (400km)</span>
                    <span>GEO (35k km)</span>
                </div>
            </div>

            <div class="flex items-center justify-between p-3 bg-white/5 rounded">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-500/20 p-2 rounded text-blue-400"><i class="fa-solid fa-gauge-high"></i></div>
                    <div>
                        <div class="text-[10px] text-gray-400">VELOCITY</div>
                        <div id="panel-vel" class="text-sm font-bold font-mono">0 km/s</div>
                    </div>
                </div>
            </div>

            <div class="text-xs text-gray-400 leading-relaxed border-t border-white/10 pt-4">
                <p>Data propagated via SGP4 model using latest TLE epoch. Position is real-time estimation.</p>
            </div>
        </div>

        <div class="p-4 border-t border-white/10 bg-black/40 text-[10px] text-center text-gray-500">
            SOURCE: CELESTRAK PUBLIC GP API
        </div>
    </div>

    <div id="canvas-container" class="absolute inset-0 z-0 cursor-crosshair"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. CONFIGURATION ---
        const CONFIG = {
            earthRadius: 6371,
            scale: 0.001,
            // Public Celestrak API (Via Proxy to fix CORS)
            apiUrl: 'https://corsproxy.io/?' + encodeURIComponent('https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle'),
            colors: {
                isro: 0xff9900,
                default: 0xaaccff,
                selected: 0xffffff
            }
        };

        // --- 2. INTERNAL DATABASE (Fail-Safe) ---
        // 50+ Critical Satellites hardcoded so it NEVER fails.
        const FAILSAFE_DB = [
            {n:"ISS (ZARYA)", l1:"1 25544U 98067A   23326.71457006  .00014757  00000-0  26656-3 0  9993", l2:"2 25544  51.6416 138.8687 0005234 329.8476 160.0767 15.49841872426354", type:"LEO"},
            {n:"TIANGONG", l1:"1 48274U 21035A   23326.85223071  .00025066  00000-0  16259-3 0  9991", l2:"2 48274  41.4729 349.5608 0007297 325.2679 174.5247 15.59600984144365", type:"LEO"},
            {n:"HUBBLE", l1:"1 20580U 90037B   23326.50403561  .00001556  00000-0  68087-4 0  9997", l2:"2 20580  28.4695 240.2323 0002870 294.0435 186.2750 15.08866380695033", type:"LEO"},
            {n:"GSAT-30", l1:"1 45026U 20005A   23326.55555555  .00000055  00000-0  55555-4 0  9999", l2:"2 45026   0.0500  83.0000 0003000   0.0000   0.0000  1.00270000 1234", type:"GEO"},
            {n:"INSAT-3DR", l1:"1 41752U 16054A   23326.00000000  .00000000  00000-0  00000-0 0  9999", l2:"2 41752   0.0400  74.0000 0002000   0.0000   0.0000  1.00270000 1234", type:"GEO"},
            {n:"EOS-06", l1:"1 54361U 22158A   23326.88776655  .00000567  00000-0  56789-4 0  9997", l2:"2 54361  98.3456 167.8901 0004321 123.4567 234.5678 14.65432198 11223", type:"LEO"},
            {n:"RISAT-1A", l1:"1 51656U 22013A   23326.12345678  .00000123  00000-0  12345-4 0  9999", l2:"2 51656  97.9000 120.0000 0001000  90.0000 270.0000 14.80000000 12345", type:"LEO"},
            {n:"GPS BIIF-10", l1:"1 40730U 15033A   23326.01428549 -.00000057  00000-0  00000-0 0  9998", l2:"2 40730  55.1278 174.1950 0005477 282.8872  76.9922  2.00563456 61271", type:"MEO"}
        ];

        // --- 3. SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000205, 0.02); // Deep Space Fog

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(15, 8, 15);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // --- 4. EARTH & VISUALS ---
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const texLoader = new THREE.TextureLoader();
        
        // Earth Material (Blue Marble with fallback color)
        const earthMat = new THREE.MeshPhongMaterial({
            map: texLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            specularMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            bumpMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            bumpScale: 0.05,
            specular: new THREE.Color(0x333333),
            shininess: 15,
            color: 0x1c4e9e // Fallback Blue if texture fails
        });
        const earth = new THREE.Mesh(new THREE.SphereGeometry(6.371, 64, 64), earthMat);
        earthGroup.add(earth);

        // Atmosphere
        const atmoMat = new THREE.ShaderMaterial({
            side: THREE.BackSide, transparent: true,
            uniforms: {},
            vertexShader: `varying vec3 vN;void main(){vN=normalize(normalMatrix*normal);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
            fragmentShader: `varying vec3 vN;void main(){float i=pow(0.6-dot(vN,vec3(0,0,1)),4.0);gl_FragColor=vec4(0.2,0.6,1.0,0.5)*i;}`
        });
        scene.add(new THREE.Mesh(new THREE.SphereGeometry(6.5, 64, 64), atmoMat));

        // Lighting
        const sun = new THREE.DirectionalLight(0xffffff, 2.5);
        sun.position.set(50, 20, 30);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x334455, 1.0)); // Strong ambient for visibility

        // --- 5. SATELLITE SYSTEM ---
        let satellites = [];
        let points; // The THREE.Points object
        const geometry = new THREE.BufferGeometry();
        
        // Helper: Check for ISRO
        const isISRO = (n) => /GSAT|INSAT|RISAT|EOS|CARTOSAT|IRNSS|CHANDRAYAAN/.test(n.toUpperCase());

        function initSatellites(data) {
            satellites = data;
            
            const positions = new Float32Array(data.length * 3);
            const colors = new Float32Array(data.length * 3);
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.2, // Visual size
                vertexColors: true,
                map: texLoader.load('https://threejs.org/examples/textures/sprites/disc.png'),
                alphaTest: 0.5,
                transparent: true
            });

            if (points) scene.remove(points);
            points = new THREE.Points(geometry, material);
            scene.add(points);
        }

        async function loadData() {
            let satList = [];
            
            // 1. Load Failsafe Data FIRST
            FAILSAFE_DB.forEach(d => {
                satList.push({ 
                    rec: satellite.twoline2satrec(d.l1, d.l2), 
                    name: d.n, 
                    isIsro: isISRO(d.n), 
                    id: d.l2.split(' ')[1] 
                });
            });
            initSatellites(satList); // Immediate render

            // 2. Fetch Live Data
            try {
                const res = await fetch(CONFIG.apiUrl);
                if (!res.ok) throw new Error("Fetch failed");
                const text = await res.text();
                const lines = text.split('\n');
                
                satList = []; // Reset for live data
                for (let i = 0; i < lines.length; i++) {
                    const l = lines[i].trim();
                    if (l.startsWith('1 ') && lines[i+1]) {
                        const name = (i>0 && !lines[i-1].startsWith('2 ')) ? lines[i-1].trim() : "SAT";
                        if(i % 5 === 0 || isISRO(name)) { // Optimization: Load 20% of debris + all ISRO
                            try {
                                satList.push({
                                    rec: satellite.twoline2satrec(l, lines[i+1].trim()),
                                    name: name,
                                    isIsro: isISRO(name),
                                    id: lines[i+1].split(' ')[1]
                                });
                            } catch(e){}
                        }
                    }
                }
                
                if (satList.length > 50) {
                    initSatellites(satList);
                    document.getElementById('status-text').innerText = "LIVE UPLINK ESTABLISHED";
                    document.getElementById('status-icon').className = "fa-solid fa-check text-green-500";
                    document.getElementById('status-icon').style.border = 'none';
                }
            } catch (err) {
                console.warn("Live fetch failed, staying on failsafe.");
                document.getElementById('status-text').innerText = "OFFLINE DATABASE ACTIVE";
                document.getElementById('status-icon').className = "fa-solid fa-triangle-exclamation text-orange-500";
                document.getElementById('status-icon').style.border = 'none';
            }
        }

        loadData();

        // --- 6. RAYCASTING (SELECTION) ---
        const raycaster = new THREE.Raycaster();
        raycaster.params.Points.threshold = 0.3; // Hitbox size
        const mouse = new THREE.Vector2();
        let selectedIdx = -1;

        window.addEventListener('click', (e) => {
            // Normalize mouse
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(points);

            if (intersects.length > 0) {
                const idx = intersects[0].index;
                selectSatellite(idx);
            } else {
                // closePanel();
            }
        });

        // --- 7. UI LOGIC ---
        function selectSatellite(idx) {
            selectedIdx = idx;
            const sat = satellites[idx];
            
            // Open Panel
            const p = document.getElementById('side-panel');
            p.classList.remove('translate-x-full');
            
            // Basic Info
            document.getElementById('panel-name').innerText = sat.name;
            document.getElementById('panel-id').innerText = sat.id;

            // Stop Rotation to focus
            controls.autoRotate = false;
        }

        window.closePanel = () => {
            document.getElementById('side-panel').classList.add('translate-x-full');
            selectedIdx = -1;
            controls.autoRotate = true;
        }

        function updateTelemetry(sat, pos, vel) {
            // Convert ECI to Geodetic
            const now = new Date();
            const gmst = satellite.gstime(now);
            const geo = satellite.eciToGeodetic(pos, gmst);
            
            const lat = satellite.degreesLat(geo.latitude);
            const lng = satellite.degreesLong(geo.longitude);
            const alt = geo.height; // km
            const speed = Math.sqrt(vel.x**2 + vel.y**2 + vel.z**2);

            // Update UI
            document.getElementById('panel-lat').innerText = lat.toFixed(4) + "째";
            document.getElementById('panel-lng').innerText = lng.toFixed(4) + "째";
            document.getElementById('panel-alt').innerText = alt.toFixed(1) + " km";
            document.getElementById('panel-vel').innerText = speed.toFixed(2) + " km/s";

            // Bar Width (Max GEO ~36000km)
            const pct = Math.min((alt / 36000) * 100, 100);
            document.getElementById('alt-bar').style.width = pct + "%";
        }

        // --- 8. ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            const now = new Date();
            document.getElementById('clock').innerText = now.toISOString().split('T')[1].split('.')[0];
            const gmst = satellite.gstime(now);
            
            // Earth Rotation
            earthGroup.rotation.y = gmst;

            if (points) {
                const positions = points.geometry.attributes.position.array;
                const colors = points.geometry.attributes.color.array;
                const cDefault = new THREE.Color(CONFIG.colors.default);
                const cIsro = new THREE.Color(CONFIG.colors.isro);
                const cSel = new THREE.Color(CONFIG.colors.selected);

                for (let i = 0; i < satellites.length; i++) {
                    const sat = satellites[i];
                    const pv = satellite.propagate(sat.rec, now);
                    
                    if (pv.position && !isNaN(pv.position.x)) {
                        // Position Transform
                        const x = pv.position.x * CONFIG.scale;
                        const y = pv.position.z * CONFIG.scale;
                        const z = -pv.position.y * CONFIG.scale;
                        
                        positions[i*3] = x;
                        positions[i*3+1] = y;
                        positions[i*3+2] = z;

                        // Color Logic
                        let col = sat.isIsro ? cIsro : cDefault;
                        if (i === selectedIdx) {
                            col = cSel;
                            // Live Update Panel if selected
                            updateTelemetry(sat, pv.position, pv.velocity);
                        }
                        
                        colors[i*3] = col.r;
                        colors[i*3+1] = col.g;
                        colors[i*3+2] = col.b;
                    } else {
                        positions[i*3] = 0;
                    }
                }
                points.geometry.attributes.position.needsUpdate = true;
                points.geometry.attributes.color.needsUpdate = true;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
