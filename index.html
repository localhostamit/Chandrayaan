<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Command | Robust Tracking</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; }
        #canvas-container { width: 100vw; height: 100vh; }
        
        /* Animations */
        .loader {
            border-top-color: #3b82f6;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .scan-line {
            background: linear-gradient(to bottom, transparent, rgba(59, 130, 246, 0.2), transparent);
            animation: scan 4s linear infinite;
        }
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
    </style>
</head>
<body class="text-white font-mono antialiased selection:bg-blue-500 selection:text-white">

    <div class="absolute inset-0 pointer-events-none z-0 scan-line"></div>
    <div class="absolute inset-0 pointer-events-none z-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBmaWxsPSIjMMzMiAvPgo8L3N2Zz4=')] opacity-20"></div>

    <div class="absolute top-0 left-0 w-full h-full pointer-events-none z-10 p-4 md:p-8 flex flex-col justify-between">
        
        <div class="flex justify-between items-start pointer-events-auto">
            <div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">
                        ORBITAL<span class="text-white">VISUALIZER</span>
                    </h1>
                </div>
                <div class="mt-4 flex flex-col gap-2">
                    <div class="flex gap-4 text-xs md:text-sm">
                        <div class="bg-gray-900/80 backdrop-blur border border-white/10 px-3 py-1 rounded">
                            <span class="text-gray-500 uppercase tracking-wider text-[10px]">Objects</span>
                            <div id="sat-count" class="text-lg font-bold text-cyan-400 font-mono">0</div>
                        </div>
                        <div class="bg-gray-900/80 backdrop-blur border border-white/10 px-3 py-1 rounded">
                            <span class="text-gray-500 uppercase tracking-wider text-[10px]">Source</span>
                            <div id="data-source" class="text-lg font-bold text-gray-400 font-mono">CONNECTING</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-right hidden md:block">
                <div id="clock-utc" class="text-2xl font-light tracking-widest tabular-nums">00:00:00</div>
                <div class="text-[10px] text-gray-500 font-bold tracking-[0.2em] mt-1">UTC STANDARD</div>
            </div>
        </div>

        <div id="loader" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center pointer-events-auto transition-opacity duration-500">
            <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-800 h-16 w-16 mb-6"></div>
            <div class="text-center">
                <h2 class="text-lg font-bold tracking-widest animate-pulse text-blue-400">INITIALIZING UPLINK</h2>
                <p class="text-xs text-gray-500 mt-2 font-mono">Handshaking with NORAD servers...</p>
            </div>
        </div>

        <div class="pointer-events-auto w-full flex justify-between items-end">
            <div class="bg-gray-900/80 backdrop-blur border border-white/10 rounded p-3 max-w-xs hidden md:block">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold text-blue-400">TELEMETRY</span>
                    <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]"></span>
                </div>
                <div class="text-[10px] text-gray-400 font-mono space-y-1">
                    <div class="flex justify-between"><span>PROPAGATION:</span> <span class="text-white">SGP4</span></div>
                    <div class="flex justify-between"><span>FRAME TIME:</span> <span class="text-white" id="fps-val">16ms</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- BACKUP DATA (Used if API Fails) ---
        // Includes ISS, Hubble, CSS, some Starlinks, GPS, NOAA
        const BACKUP_TLE_DATA = `
ISS (ZARYA)
1 25544U 98067A   23326.71457006  .00014757  00000-0  26656-3 0  9993
2 25544  51.6416 138.8687 0005234 329.8476 160.0767 15.49841872426354
HUBBLE SPACE TELESCOPE
1 20580U 90037B   23326.50403561  .00001556  00000-0  68087-4 0  9997
2 20580  28.4695 240.2323 0002870 294.0435 186.2750 15.08866380695033
TIANGONG
1 48274U 21035A   23326.85223071  .00025066  00000-0  16259-3 0  9991
2 48274  41.4729 349.5608 0007297 325.2679 174.5247 15.59600984144365
NOAA 19
1 33591U 09005A   23326.90442387  .00000185  00000-0  13511-3 0  9995
2 33591  99.1085 243.6823 0014169 191.0777 169.0270 14.12935824765636
STARLINK-1007
1 44713U 19074A   23326.25001157  .00000302  00000-0  27572-4 0  9994
2 44713  53.0538 178.6015 0001546  89.6548 270.4578 15.06392095217985
GPS BIIF-10 (PRN 08)
1 40730U 15033A   23326.01428549 -.00000057  00000-0  00000-0 0  9998
2 40730  55.1278 174.1950 0005477 282.8872  76.9922  2.00563456 61271
`;

        // --- CONFIG ---
        const CONFIG = {
            earthRadius: 6371,
            scale: 0.001,
            satCount: 5000,
            proxyUrl: 'https://corsproxy.io/?', 
            targetUrl: 'https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle'
        };

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.01, 1000);
        camera.position.set(12, 6, 12);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.6;
        controls.minDistance = 7;
        controls.maxDistance = 60;

        // --- OBJECTS ---
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const textureLoader = new THREE.TextureLoader();

        // Earth
        const earthGeo = new THREE.SphereGeometry(CONFIG.earthRadius * CONFIG.scale, 64, 64);
        const earthMat = new THREE.MeshPhongMaterial({
            map: textureLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            bumpMap: textureLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            specularMap: textureLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            bumpScale: 0.02,
            specular: new THREE.Color(0x333333),
            shininess: 15
        });
        const earth = new THREE.Mesh(earthGeo, earthMat);
        earthGroup.add(earth);

        // Atmosphere Glow
        const atmoGeo = new THREE.SphereGeometry(CONFIG.earthRadius * CONFIG.scale + 0.1, 64, 64);
        const atmoMat = new THREE.ShaderMaterial({
            side: THREE.BackSide,
            transparent: true,
            uniforms: {},
            vertexShader: `
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.65 - dot(vNormal, vec3(0, 0, 1.0)), 4.0);
                    gl_FragColor = vec4(0.2, 0.5, 1.0, 0.6) * intensity;
                }
            `
        });
        const atmosphere = new THREE.Mesh(atmoGeo, atmoMat);
        scene.add(atmosphere);

        // Sun
        const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
        sunLight.position.set(10, 3, 5);
        scene.add(sunLight);
        scene.add(new THREE.AmbientLight(0x000510)); // Deep blue ambient

        // Stars
        const starsGeo = new THREE.BufferGeometry();
        const starCount = 3000;
        const starPos = new Float32Array(starCount * 3);
        for(let i=0; i<starCount*3; i++) starPos[i] = (Math.random() - 0.5) * 600;
        starsGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starsMat = new THREE.PointsMaterial({color:0xaaaaaa, size:0.1, transparent:true, opacity:0.8});
        scene.add(new THREE.Points(starsGeo, starsMat));

        // --- SATELLITE LOGIC ---
        let satelliteData = [];
        const satMesh = new THREE.InstancedMesh(
            new THREE.BoxGeometry(0.05, 0.05, 0.05),
            new THREE.MeshBasicMaterial({ color: 0x00ffff }),
            CONFIG.satCount
        );
        scene.add(satMesh);
        const dummy = new THREE.Object3D();

        async function initData() {
            const loaderEl = document.getElementById('loader');
            const sourceEl = document.getElementById('data-source');
            const countEl = document.getElementById('sat-count');

            try {
                // Attempt 1: Fetch Live
                console.log("Attempting live fetch...");
                const response = await fetch(CONFIG.proxyUrl + encodeURIComponent(CONFIG.targetUrl));
                if (!response.ok) throw new Error("Proxy error");
                
                const data = await response.text();
                processTLE(data);
                
                sourceEl.innerText = "LIVE (CELESTRAK)";
                sourceEl.classList.add("text-green-400");
                
            } catch (err) {
                // Attempt 2: Fallback
                console.warn("Live fetch failed, using backup.", err);
                processTLE(BACKUP_TLE_DATA);
                
                sourceEl.innerText = "OFFLINE BACKUP";
                sourceEl.classList.add("text-orange-400");
                document.querySelector('#loader h2').innerText = "CONNECTION FAILED";
                document.querySelector('#loader p').innerText = "Switched to internal database.";
            }

            // Hide loader after short delay
            setTimeout(() => {
                loaderEl.style.opacity = 0;
                setTimeout(() => loaderEl.remove(), 500);
            }, 1000);
        }

        function processTLE(tleString) {
            const lines = tleString.split('\n');
            let count = 0;
            
            // Clear existing
            satelliteData = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                // Check if this line looks like Line 1 of a TLE
                if (line.startsWith('1 ') && i + 1 < lines.length) {
                    const line1 = line;
                    const line2 = lines[i+1].trim();
                    
                    try {
                        const satrec = satellite.twoline2satrec(line1, line2);
                        satelliteData.push(satrec);
                        count++;
                        if (count >= CONFIG.satCount) break;
                    } catch(e) {}
                }
            }
            
            document.getElementById('sat-count').innerText = count;
        }

        // --- ANIMATION ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            
            const now = new Date();
            const gmst = satellite.gstime(now);
            
            // Sync Earth rotation
            earthGroup.rotation.y = gmst;

            // Update Satellites
            let i = 0;
            satelliteData.forEach(satrec => {
                const posVel = satellite.propagate(satrec, now);
                if (posVel.position) {
                    const { x, y, z } = posVel.position;
                    
                    // Convert ECI (km) to Three (units)
                    // ECI: Z is North. Three: Y is North (usually)
                    // We map ECI Z -> Three Y, and X/Y map to X/-Z to match chirality
                    const px = x * CONFIG.scale;
                    const py = z * CONFIG.scale; 
                    const pz = -y * CONFIG.scale;

                    dummy.position.set(px, py, pz);
                    dummy.rotation.set(0,0,0); // Simple point
                    dummy.updateMatrix();
                    satMesh.setMatrixAt(i++, dummy.matrix);
                }
            });

            // Hide unused instances
            while(i < CONFIG.satCount) {
                dummy.position.set(0,0,0);
                dummy.scale.set(0,0,0);
                dummy.updateMatrix();
                satMesh.setMatrixAt(i++, dummy.matrix);
            }

            satMesh.instanceMatrix.needsUpdate = true;

            // UI Updates
            document.getElementById('clock-utc').innerText = now.toISOString().split('T')[1].split('.')[0];
            document.getElementById('fps-val').innerText = Math.round(1000/60) + "ms";

            controls.update();
            renderer.render(scene, camera);
        }

        // Window Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        initData();
        animate();

    </script>
</body>
</html>
