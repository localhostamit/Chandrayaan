<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Command | Interactive Tracking</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000510; cursor: crosshair; }
        #canvas-container { width: 100vw; height: 100vh; }
        
        /* HUD Styling */
        .hud-panel {
            background: rgba(10, 20, 40, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
        }
        
        .reticle {
            position: absolute;
            pointer-events: none;
            width: 20px;
            height: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: opacity 0.2s;
            opacity: 0;
            z-index: 50;
            transform: translate(-50%, -50%);
        }

        /* Loading Scanline */
        .scanline {
            width: 100%;
            height: 2px;
            background: #3b82f6;
            animation: scan 2s linear infinite;
            opacity: 0.5;
        }
        @keyframes scan { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
    </style>
</head>
<body class="text-blue-100 font-mono antialiased">

    <div id="reticle" class="reticle"></div>

    <div id="sat-label" class="absolute hidden pointer-events-none z-50 bg-black/90 border border-blue-500 px-3 py-2 rounded text-xs">
        <h3 id="lbl-name" class="font-bold text-white text-sm">SAT_NAME</h3>
        <div class="text-blue-400">ID: <span id="lbl-id">00000</span></div>
        <div class="text-gray-400">ALT: <span id="lbl-alt">000</span> km</div>
    </div>

    <div class="absolute inset-0 pointer-events-none z-10 flex flex-col justify-between p-6">
        
        <div class="flex justify-between items-start pointer-events-auto">
            <div>
                <h1 class="text-4xl font-black tracking-tighter text-white drop-shadow-[0_0_10px_rgba(59,130,246,0.8)]">
                    ORBITAL<span class="text-blue-500">EYE</span>
                </h1>
                <div class="flex items-center gap-2 mt-2 text-xs text-blue-300">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span id="system-status">SYSTEM ONLINE</span>
                </div>
            </div>
            
            <div class="text-right">
                <div id="clock" class="text-2xl font-light tabular-nums">00:00:00 UTC</div>
                <div id="sat-total" class="text-xs text-gray-400 uppercase tracking-widest mt-1">TRACKING 0 OBJECTS</div>
            </div>
        </div>

        <div class="flex justify-between items-end pointer-events-auto">
            <div class="hud-panel p-4 rounded-lg max-w-sm">
                <h2 class="text-xs font-bold text-blue-400 mb-2 border-b border-blue-500/30 pb-1">INSTRUCTIONS</h2>
                <ul class="text-[10px] space-y-1 text-gray-300">
                    <li>• LEFT MOUSE to Rotate Earth</li>
                    <li>• SCROLL to Zoom (Data reveals on hover)</li>
                    <li>• HOVER over satellites to identify</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import * as BufferGeometryUtils from 'three/addons/utils/BufferGeometryUtils.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- HARDCODED ROBUST DATA (Ensures visuals even if API fails) ---
        // This is a curated list of ~30 bright/popular satellites
        const BACKUP_DATA = [
            {name:"ISS (ZARYA)",l1:"1 25544U 98067A   23326.71457006  .00014757  00000-0  26656-3 0  9993",l2:"2 25544  51.6416 138.8687 0005234 329.8476 160.0767 15.49841872426354"},
            {name:"TIANGONG",l1:"1 48274U 21035A   23326.85223071  .00025066  00000-0  16259-3 0  9991",l2:"2 48274  41.4729 349.5608 0007297 325.2679 174.5247 15.59600984144365"},
            {name:"HUBBLE",l1:"1 20580U 90037B   23326.50403561  .00001556  00000-0  68087-4 0  9997",l2:"2 20580  28.4695 240.2323 0002870 294.0435 186.2750 15.08866380695033"},
            {name:"NOAA 19",l1:"1 33591U 09005A   23326.90442387  .00000185  00000-0  13511-3 0  9995",l2:"2 33591  99.1085 243.6823 0014169 191.0777 169.0270 14.12935824765636"},
            {name:"LANDSAT 9",l1:"1 49260U 21088A   23326.88711964  .00000456  00000-0  11456-3 0  9994",l2:"2 49260  98.2239 123.4567 0001234 123.4567 236.5432 14.65432198123456"},
            {name:"STARLINK-1007",l1:"1 44713U 19074A   23326.25001157  .00000302  00000-0  27572-4 0  9994",l2:"2 44713  53.0538 178.6015 0001546  89.6548 270.4578 15.06392095217985"},
            {name:"GPS BIIF-10",l1:"1 40730U 15033A   23326.01428549 -.00000057  00000-0  00000-0 0  9998",l2:"2 40730  55.1278 174.1950 0005477 282.8872  76.9922  2.00563456 61271"}
        ];

        // CONFIG
        const CONFIG = {
            earthRadius: 6371,
            scale: 0.001,
            maxSatellites: 5000
        };

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(12, 8, 12);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.3;
        controls.minDistance = 7;
        controls.maxDistance = 60;

        // --- ASSETS ---
        const texLoader = new THREE.TextureLoader();

        // EARTH GROUP
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        // 1. Earth Sphere
        const earthMat = new THREE.MeshPhongMaterial({
            map: texLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            specularMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            bumpMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            bumpScale: 0.02,
            specular: new THREE.Color(0x333333),
            shininess: 5
        });
        const earth = new THREE.Mesh(new THREE.SphereGeometry(6.371, 64, 64), earthMat);
        earthGroup.add(earth);

        // 2. Atmosphere
        const atmoMat = new THREE.ShaderMaterial({
            side: THREE.BackSide,
            transparent: true,
            uniforms: {},
            vertexShader: `
                varying vec3 vNormal;
                void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }
            `,
            fragmentShader: `
                varying vec3 vNormal;
                void main() { float intensity = pow(0.7 - dot(vNormal, vec3(0, 0, 1.0)), 4.0); gl_FragColor = vec4(0.2, 0.6, 1.0, 0.6) * intensity; }
            `
        });
        const atmo = new THREE.Mesh(new THREE.SphereGeometry(6.5, 64, 64), atmoMat);
        scene.add(atmo);

        // 3. Stars
        const starGeo = new THREE.BufferGeometry();
        const starPos = [];
        for(let i=0; i<3000; i++) {
            starPos.push((Math.random()-0.5)*400, (Math.random()-0.5)*400, (Math.random()-0.5)*400);
        }
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color:0xffffff, size:0.15, transparent:true, opacity:0.8}));
        scene.add(stars);

        // 4. Sun Light
        const sun = new THREE.DirectionalLight(0xffffff, 2);
        sun.position.set(20, 10, 20);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x111122));

        // --- SATELLITE GENERATION ---
        let satelliteData = [];
        let satMesh; // InstancedMesh
        const dummy = new THREE.Object3D();

        // Create a detailed Satellite Geometry (Merged)
        function createSatelliteGeometry() {
            // Body (Cylinder)
            const bodyGeo = new THREE.CylinderGeometry(0.05, 0.05, 0.2, 8);
            bodyGeo.rotateX(Math.PI / 2);
            
            // Panels (Box)
            const panelGeo = new THREE.BoxGeometry(0.6, 0.01, 0.15);
            
            // Merge
            const geometry = BufferGeometryUtils.mergeGeometries([bodyGeo, panelGeo]);
            return geometry;
        }

        const satGeometry = createSatelliteGeometry();
        // Material: Emissive cyan for visibility + Metallic look
        const satMaterial = new THREE.MeshStandardMaterial({ 
            color: 0xaaaaaa, 
            emissive: 0x00ffff,
            emissiveIntensity: 0.4,
            roughness: 0.4,
            metalness: 0.8
        });

        // Init InstancedMesh
        satMesh = new THREE.InstancedMesh(satGeometry, satMaterial, CONFIG.maxSatellites);
        scene.add(satMesh);

        // --- DATA HANDLING ---
        function parseTLE(tleText) {
            const lines = tleText.split('\n');
            const data = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('1 ') && lines[i+1]) {
                    const l1 = line;
                    const l2 = lines[i+1].trim();
                    // Grab name if previous line exists and isn't a TLE line
                    let name = "UNKNOWN";
                    if(i > 0 && !lines[i-1].startsWith('2 ')) {
                        name = lines[i-1].trim();
                    }
                    try {
                        const rec = satellite.twoline2satrec(l1, l2);
                        data.push({ rec, name, id: l2.split(' ')[1] });
                    } catch(e){}
                }
            }
            return data;
        }

        async function initSatellites() {
            let sats = [];
            const statusEl = document.getElementById('system-status');
            
            // Load Backup first (Instant)
            BACKUP_DATA.forEach(d => {
                const rec = satellite.twoline2satrec(d.l1, d.l2);
                sats.push({ rec, name: d.name, id: "BACKUP" });
            });

            // Try Live Fetch
            try {
                // Using a reliable CORS proxy
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle'));
                if(res.ok) {
                    const text = await res.text();
                    const liveSats = parseTLE(text);
                    if(liveSats.length > 0) {
                        sats = liveSats; // Replace backup with live
                        statusEl.innerText = "LIVE UPLINK ESTABLISHED";
                        statusEl.classList.add("text-green-400");
                    }
                }
            } catch(e) {
                console.warn("Live fetch failed, using backup.");
                statusEl.innerText = "OFFLINE DATABASE ACTIVE";
                statusEl.classList.add("text-yellow-400");
            }

            // Cap at Max
            satelliteData = sats.slice(0, CONFIG.maxSatellites);
            document.getElementById('sat-total').innerText = `TRACKING ${satelliteData.length} OBJECTS`;
        }

        initSatellites();

        // --- RAYCASTER (INTERACTION) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hoveredId = null;

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            // Move Reticle
            const reticle = document.getElementById('reticle');
            reticle.style.left = e.clientX + 'px';
            reticle.style.top = e.clientY + 'px';
        });

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            const now = new Date();
            document.getElementById('clock').innerText = now.toISOString().split('.')[0] + " UTC";

            // Rotate Earth
            const gmst = satellite.gstime(now);
            earthGroup.rotation.y = gmst;

            // Update Satellite Positions
            let activeCount = 0;
            const instanceColor = new THREE.Color();

            // Prepare for Raycasting
            raycaster.setFromCamera(mouse, camera);
            // We check intersection against the InstancedMesh
            // Note: InstancedMesh raycasting is expensive for 5000 objects every frame. 
            // Optimization: Only check if throttle allows or closest distance.
            // For this demo, we check every frame but optimize loop.

            const intersection = raycaster.intersectObject(satMesh);
            let hitIndex = -1;
            if (intersection.length > 0) {
                hitIndex = intersection[0].instanceId;
                document.getElementById('reticle').style.opacity = 1;
                document.body.style.cursor = 'pointer';
            } else {
                document.getElementById('reticle').style.opacity = 0;
                document.body.style.cursor = 'crosshair';
            }

            // Update Matrix
            for (let i = 0; i < satelliteData.length; i++) {
                const sat = satelliteData[i];
                const pv = satellite.propagate(sat.rec, now);
                
                if (pv.position && !isNaN(pv.position.x)) {
                    // Coordinate Mapping (ECI to Three)
                    const x = pv.position.x * CONFIG.scale;
                    const y = pv.position.z * CONFIG.scale; // Z -> Y
                    const z = -pv.position.y * CONFIG.scale;

                    dummy.position.set(x, y, z);
                    dummy.lookAt(0, 0, 0); // Face Earth
                    dummy.updateMatrix();
                    satMesh.setMatrixAt(i, dummy.matrix);

                    // Coloring: Highlight hovered
                    if (i === hitIndex) {
                        satMesh.setColorAt(i, instanceColor.setHex(0xff0000)); // RED for hovered
                        
                        // Update HUD Data
                        const hud = document.getElementById('sat-label');
                        hud.style.display = 'block';
                        // Project 3D pos to 2D screen
                        const vec = new THREE.Vector3(x, y, z);
                        vec.project(camera);
                        const sx = (vec.x * .5 + .5) * window.innerWidth;
                        const sy = (-(vec.y * .5) - .5) * window.innerHeight * -1; // flip Y
                        
                        hud.style.left = (sx + 15) + 'px';
                        hud.style.top = (sy - 15) + 'px';

                        document.getElementById('lbl-name').innerText = sat.name;
                        // Calculate Approx Altitude (Magnitude - Earth Radius)
                        const r = Math.sqrt(pv.position.x**2 + pv.position.y**2 + pv.position.z**2);
                        document.getElementById('lbl-alt').innerText = Math.round(r - 6371);
                        document.getElementById('lbl-id').innerText = sat.id || "N/A";

                    } else {
                        satMesh.setColorAt(i, instanceColor.setHex(0x00ffff)); // Default Cyan
                    }

                    activeCount++;
                } else {
                    // Hide invalid
                    dummy.position.set(0, 0, 0);
                    dummy.scale.set(0, 0, 0);
                    dummy.updateMatrix();
                    satMesh.setMatrixAt(i, dummy.matrix);
                }
            }

            // Hide label if no hit
            if (hitIndex === -1) {
                document.getElementById('sat-label').style.display = 'none';
            }

            satMesh.instanceMatrix.needsUpdate = true;
            if (satMesh.instanceColor) satMesh.instanceColor.needsUpdate = true;

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
