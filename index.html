<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Command | Guaranteed Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #canvas-container { width: 100vw; height: 100vh; }
    </style>
</head>
<body class="text-white font-mono">

    <div class="absolute top-0 left-0 p-4 pointer-events-none z-10">
        <h1 class="text-2xl font-bold text-red-500">DEBUG MODE</h1>
        <div class="bg-gray-900/80 p-2 rounded mt-2 border border-red-500/50">
            <p>Satellites Loaded: <span id="sat-count" class="text-white font-bold">0</span></p>
            <p class="text-xs text-gray-400">If you see Earth but no dots, zoom in/out.</p>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. GUARANTEED DATA (Direct Object Array) ---
        // We skip text parsing to ensure this works.
        const RELIABLE_SATELLITES = [
            {
                name: "ISS (ZARYA)",
                line1: "1 25544U 98067A   23326.71457006  .00014757  00000-0  26656-3 0  9993",
                line2: "2 25544  51.6416 138.8687 0005234 329.8476 160.0767 15.49841872426354"
            },
            {
                name: "HUBBLE",
                line1: "1 20580U 90037B   23326.50403561  .00001556  00000-0  68087-4 0  9997",
                line2: "2 20580  28.4695 240.2323 0002870 294.0435 186.2750 15.08866380695033"
            },
            {
                name: "GPS BIIF-10",
                line1: "1 40730U 15033A   23326.01428549 -.00000057  00000-0  00000-0 0  9998",
                line2: "2 40730  55.1278 174.1950 0005477 282.8872  76.9922  2.00563456 61271"
            },
            {
                name: "STARLINK-1007",
                line1: "1 44713U 19074A   23326.25001157  .00000302  00000-0  27572-4 0  9994",
                line2: "2 44713  53.0538 178.6015 0001546  89.6548 270.4578 15.06392095217985"
            }
        ];

        // --- 2. CONFIG ---
        // Earth Radius in KM
        const R_KM = 6371;
        // Scale Factor: 1 unit = 1000 km
        const SCALE = 0.001; 
        const R_3D = R_KM * SCALE; // approx 6.37 units

        // --- 3. SCENE SETUP ---
        const scene = new THREE.Scene();
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(18, 10, 18); // Far enough to see everything

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true; 
        controls.autoRotateSpeed = 1.0;

        // --- 4. EARTH MESH ---
        const textureLoader = new THREE.TextureLoader();
        const earthGeo = new THREE.SphereGeometry(R_3D, 32, 32);
        const earthMat = new THREE.MeshPhongMaterial({ 
            map: textureLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            specular: new THREE.Color('grey'),
            shininess: 10
        });
        const earth = new THREE.Mesh(earthGeo, earthMat);
        scene.add(earth);

        // Lighting
        const sun = new THREE.DirectionalLight(0xffffff, 2);
        sun.position.set(10, 5, 10);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x404040, 2)); // High ambient so we can see everything

        // --- 5. SATELLITE SYSTEM ---
        const satRecords = [];
        
        // Convert static data to SatRec objects immediately
        RELIABLE_SATELLITES.forEach(data => {
            try {
                const satrec = satellite.twoline2satrec(data.line1, data.line2);
                satRecords.push(satrec);
            } catch (err) {
                console.error("TLE Error:", err);
            }
        });

        // Update HUD
        document.getElementById('sat-count').innerText = satRecords.length;

        // Create Mesh Instances
        // MAKING THEM HUGE & RED SO YOU CAN'T MISS THEM
        const satGeo = new THREE.BoxGeometry(0.3, 0.3, 0.3); 
        const satMat = new THREE.MeshBasicMaterial({ color: 0xff0000 }); // RED
        const satMesh = new THREE.InstancedMesh(satGeo, satMat, satRecords.length);
        scene.add(satMesh);
        
        const dummy = new THREE.Object3D();

        // --- 6. ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            
            const now = new Date();
            
            // Rotate Earth to match time (GMST)
            const gmst = satellite.gstime(now);
            earth.rotation.y = gmst;

            satRecords.forEach((satrec, i) => {
                // Propagate
                const posVel = satellite.propagate(satrec, now);
                
                if (posVel.position) {
                    const p = posVel.position;
                    
                    // Coordinate Mapping
                    // Satellite.js (ECI) -> Three.js
                    // X -> X
                    // Y -> -Z
                    // Z -> Y
                    const x = p.x * SCALE;
                    const y = p.z * SCALE; 
                    const z = -p.y * SCALE;

                    dummy.position.set(x, y, z);
                    dummy.lookAt(0,0,0); // Look at earth center
                    dummy.updateMatrix();
                    satMesh.setMatrixAt(i, dummy.matrix);
                }
            });

            satMesh.instanceMatrix.needsUpdate = true;
            controls.update();
            renderer.render(scene, camera);
        }

        // --- 7. ATTEMPT LIVE DATA FETCH (Non-Blocking) ---
        // We try to fetch more data, but if it fails, the Red satellites remain.
        fetch('https://corsproxy.io/?' + encodeURIComponent('https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle'))
            .then(res => res.text())
            .then(text => {
                console.log("Live data received");
                // In a full app, we would parse this and add to the scene.
                // For this debug version, we just log success.
                console.log("Characters received: " + text.length);
            })
            .catch(err => console.log("Live fetch failed (Expected on some networks)"));

        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
