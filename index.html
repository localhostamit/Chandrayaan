<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISRO TRACKER | LIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        
        /* Force Canvas to be visible */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1; /* Behind UI, but visible */
        }

        /* UI Layer on top */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to canvas */
        }

        .pointer-auto { pointer-events: auto; }

        /* Glass Panel */
        .glass {
            background: rgba(10, 20, 30, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer" class="flex flex-col justify-between p-6">
        
        <div class="flex justify-between items-start">
            <div class="flex items-center gap-4 pointer-auto">
                <div class="bg-white p-2 rounded shadow-lg">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/bd/Indian_Space_Research_Organisation_Logo.svg" 
                         class="h-12 w-auto md:h-14"> 
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tighter drop-shadow-md">
                        ISRO<span class="text-orange-500">NET</span>
                    </h1>
                    <div class="flex items-center gap-2 text-xs text-blue-300 font-mono">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        LIVE TRACKING
                    </div>
                </div>
            </div>

            <div class="text-right hidden md:block">
                <div id="clock" class="text-4xl font-light text-white font-mono tabular-nums">00:00:00</div>
                <div class="text-xs text-gray-400 tracking-widest">UTC STANDARD</div>
            </div>
        </div>

        <div id="sat-card" class="self-end mb-10 w-72 glass rounded-lg p-4 transform translate-x-full transition-transform duration-300 pointer-auto hidden">
            <h2 id="card-name" class="text-xl font-bold text-white border-b border-gray-600 pb-2 mb-2">SAT NAME</h2>
            <div class="space-y-2 text-sm text-gray-300 font-mono">
                <div class="flex justify-between"><span>TYPE:</span> <span id="card-type" class="text-orange-400">ISRO</span></div>
                <div class="flex justify-between"><span>ALTITUDE:</span> <span id="card-alt" class="text-white">0 km</span></div>
                <div class="flex justify-between"><span>SPEED:</span> <span id="card-spd" class="text-white">7.6 km/s</span></div>
            </div>
        </div>

        <div class="glass self-start px-4 py-2 rounded pointer-auto">
            <div class="text-xs text-gray-400 font-bold">TOTAL ASSETS</div>
            <div class="text-2xl text-white font-mono" id="sat-count">LOADING...</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // CONFIG
        const EARTH_R = 6371;
        const SCALE = 0.001; // 1 unit = 1000km
        const MAX_SATS = 5000;

        // SCENE
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205); // Dark Blue-Black Background
        scene.fog = new THREE.FogExp2(0x020205, 0.02);

        // CAMERA
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(18, 10, 18);

        // RENDERER
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // CONTROLS
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // --- EARTH (FAILSAFE) ---
        // We use a base blue color. If texture loads, it overrides.
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const texLoader = new THREE.TextureLoader();
        
        // 1. Create a "Base" Earth (Solid Blue) immediately visible
        const earthGeo = new THREE.SphereGeometry(6.371, 64, 64);
        const earthMat = new THREE.MeshPhongMaterial({
            color: 0x112255, // Solid Blue fallback
            emissive: 0x000022,
            specular: 0x111111,
            shininess: 10
        });
        
        // 2. Try to load texture
        texLoader.load(
            'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg',
            (texture) => {
                earthMat.map = texture;
                earthMat.color.setHex(0xffffff); // Reset color if texture loads
                earthMat.needsUpdate = true;
            },
            undefined,
            (err) => console.log("Texture failed, keeping blue sphere.")
        );

        const earth = new THREE.Mesh(earthGeo, earthMat);
        earthGroup.add(earth);

        // Atmosphere Glow
        const atmoGeo = new THREE.SphereGeometry(6.5, 64, 64);
        const atmoMat = new THREE.ShaderMaterial({
            transparent: true,
            side: THREE.BackSide,
            vertexShader: `
                varying vec3 vNormal;
                void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }
            `,
            fragmentShader: `
                varying vec3 vNormal;
                void main() { float i = pow(0.6 - dot(vNormal, vec3(0,0,1)), 3.0); gl_FragColor = vec4(0.2, 0.5, 1.0, 0.4) * i; }
            `
        });
        scene.add(new THREE.Mesh(atmoGeo, atmoMat));

        // LIGHTS
        const sun = new THREE.DirectionalLight(0xffffff, 2);
        sun.position.set(10, 5, 10);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x404040, 2)); // Strong ambient light to ensure visibility

        // --- SATELLITES (POINT CLOUD) ---
        let satellites = [];
        let pointsSystem;
        const satGeo = new THREE.BufferGeometry();
        
        function initSatellites(data) {
            satellites = data;
            const pos = new Float32Array(data.length * 3);
            const cols = new Float32Array(data.length * 3);
            const sizes = new Float32Array(data.length);

            satGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            satGeo.setAttribute('color', new THREE.BufferAttribute(cols, 3));
            // satGeo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            const mat = new THREE.PointsMaterial({
                size: 0.15,
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                sizeAttenuation: true
            });

            pointsSystem = new THREE.Points(satGeo, mat);
            scene.add(pointsSystem);
            document.getElementById('sat-count').innerText = data.length;
        }

        // --- DATA ---
        const BACKUP = [
            {n:"ISS", l1:"1 25544U 98067A   23326.71457006  .00014757  00000-0  26656-3 0  9993", l2:"2 25544  51.6416 138.8687 0005234 329.8476 160.0767 15.49841872426354", isro:false},
            {n:"GSAT-30 (ISRO)", l1:"1 45026U 20005A   23326.55555555  .00000055  00000-0  55555-4 0  9999", l2:"2 45026   0.0500  83.0000 0003000   0.0000   0.0000  1.00270000 1234", isro:true},
        ];

        async function loadData() {
            let parsed = [];
            // Load Backup first
            BACKUP.forEach(d => parsed.push({rec: satellite.twoline2satrec(d.l1, d.l2), name: d.n, isIsro: d.isro}));
            
            try {
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle'));
                const text = await res.text();
                const lines = text.split('\n');
                
                for(let i=0; i<lines.length; i++) {
                    const l = lines[i].trim();
                    if(l.startsWith('1 ') && lines[i+1]) {
                        const name = (i>0 && !lines[i-1].startsWith('2 ')) ? lines[i-1].trim() : "SAT";
                        const isIsro = name.includes('GSAT') || name.includes('INSAT') || name.includes('RISAT') || name.includes('EOS');
                        parsed.push({
                            rec: satellite.twoline2satrec(l, lines[i+1].trim()),
                            name: name,
                            isIsro: isIsro
                        });
                    }
                }
            } catch(e) { console.log("Live fetch failed, using backup"); }
            
            // Prioritize ISRO
            parsed.sort((a,b) => (b.isIsro ? 1 : 0) - (a.isIsro ? 1 : 0));
            initSatellites(parsed.slice(0, MAX_SATS));
        }

        loadData();

        // --- INTERACTION ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        raycaster.params.Points.threshold = 0.2;
        let hoveredIndex = -1;

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        });

        const card = document.getElementById('sat-card');

        // --- ANIMATE ---
        function animate() {
            requestAnimationFrame(animate);

            const now = new Date();
            document.getElementById('clock').innerText = now.toISOString().split('T')[1].split('.')[0];

            // Earth Rotation
            const gmst = satellite.gstime(now);
            earthGroup.rotation.y = gmst;

            if(pointsSystem) {
                const pos = pointsSystem.geometry.attributes.position.array;
                const col = pointsSystem.geometry.attributes.color.array;

                for(let i=0; i<satellites.length; i++) {
                    const sat = satellites[i];
                    const pv = satellite.propagate(sat.rec, now);
                    
                    if(pv.position && !isNaN(pv.position.x)) {
                        const x = pv.position.x * SCALE;
                        const y = pv.position.z * SCALE;
                        const z = -pv.position.y * SCALE;
                        
                        pos[i*3] = x;
                        pos[i*3+1] = y;
                        pos[i*3+2] = z;

                        // Colors
                        if(i === hoveredIndex) {
                            col[i*3] = 1; col[i*3+1] = 1; col[i*3+2] = 1; // White
                        } else if(sat.isIsro) {
                            col[i*3] = 1; col[i*3+1] = 0.5; col[i*3+2] = 0; // Orange
                        } else {
                            col[i*3] = 0.2; col[i*3+1] = 0.5; col[i*3+2] = 1; // Blue
                        }
                    } else {
                        pos[i*3] = 0; // Hide invalid
                    }
                }
                pointsSystem.geometry.attributes.position.needsUpdate = true;
                pointsSystem.geometry.attributes.color.needsUpdate = true;

                // Raycasting
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObject(pointsSystem);
                
                if(intersects.length > 0) {
                    const idx = intersects[0].index;
                    if(hoveredIndex !== idx) {
                        hoveredIndex = idx;
                        const s = satellites[idx];
                        
                        card.classList.remove('hidden', 'translate-x-full');
                        document.getElementById('card-name').innerText = s.name;
                        document.getElementById('card-type').innerText = s.isIsro ? "ISRO ASSET" : "INTERNATIONAL";
                        document.getElementById('card-type').className = s.isIsro ? "text-orange-400 font-bold" : "text-blue-400";
                        document.getElementById('card-alt').innerText = Math.round(intersects[0].distance/SCALE - 6371) + " km";
                    }
                } else {
                    hoveredIndex = -1;
                    card.classList.add('translate-x-full');
                }
            }

            controls.update();
            renderer.render(scene, camera);
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>
