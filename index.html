<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISRO SAT-NAV | Mission Control</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        :root {
            --isro-orange: #ff9933;
            --isro-blue: #138808; /* Using flag green as secondary or tech blue */
            --hud-bg: rgba(10, 15, 30, 0.75);
            --hud-border: rgba(255, 255, 255, 0.1);
        }

        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; 
            font-family: 'Rajdhani', sans-serif; 
            color: #fff;
        }

        /* Scanline Effect */
        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            position: absolute;
            pointer-events: none;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 5;
            opacity: 0.15;
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: var(--hud-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--hud-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .font-mono-tech { font-family: 'Share Tech Mono', monospace; }
        
        /* Loading Animation */
        .loader-ring {
            border: 3px solid rgba(255, 153, 51, 0.1);
            border-left-color: #ff9933;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .isro-logo-filter {
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }
    </style>
</head>
<body class="selection:bg-orange-500 selection:text-white">

    <div class="scanlines"></div>
    
    <div class="absolute top-0 left-0 w-full p-6 z-20 pointer-events-none flex justify-between items-start">
        <div class="flex items-center gap-5 pointer-events-auto">
            <div class="bg-white/90 p-3 rounded-md shadow-lg shadow-orange-500/20">
                <img src="https://upload.wikimedia.org/wikipedia/commons/b/bd/Indian_Space_Research_Organisation_Logo.svg" 
                     alt="ISRO" class="h-12 w-auto object-contain">
            </div>
            <div>
                <h1 class="text-4xl font-bold tracking-tight leading-none text-transparent bg-clip-text bg-gradient-to-r from-orange-400 via-white to-green-400 filter drop-shadow-md">
                    INDIAN SPACE RESEARCH ORG
                </h1>
                <div class="flex items-center gap-3 mt-1">
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-orange-600 text-white tracking-widest">OFFICIAL DATA LINK</span>
                    <span class="text-xs text-blue-300 font-mono-tech tracking-wider">LIVE TELEMETRY</span>
                </div>
            </div>
        </div>

        <div class="text-right hidden md:block">
            <div id="clock-utc" class="text-5xl font-mono-tech text-white/90 tracking-widest">00:00:00</div>
            <div class="text-xs text-orange-400 font-bold tracking-[0.4em] mt-1">UTC ZULU TIME</div>
        </div>
    </div>

    <div id="info-panel" class="absolute top-32 right-6 w-80 glass-panel rounded-xl p-0 z-20 transform translate-x-full opacity-0 transition-all duration-500 pointer-events-auto overflow-hidden">
        <div class="bg-gradient-to-r from-orange-600 to-orange-800 p-3 flex justify-between items-center">
            <h2 class="font-bold text-white tracking-wider flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                TARGET ACQUIRED
            </h2>
            <button onclick="closePanel()" class="text-white/70 hover:text-white">âœ•</button>
        </div>
        
        <div class="p-5 space-y-4">
            <div>
                <div class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">DESIGNATION</div>
                <div id="sat-name" class="text-2xl font-bold text-white font-mono-tech break-words leading-none">SAT_NAME</div>
                <div id="sat-id" class="text-xs text-orange-400 font-mono-tech mt-1">NORAD ID: 00000</div>
            </div>

            <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                <div>
                    <div class="text-[10px] text-gray-400 uppercase">ALTITUDE</div>
                    <div class="text-xl font-mono-tech text-blue-300"><span id="sat-alt">0</span> <span class="text-xs text-gray-500">km</span></div>
                </div>
                <div>
                    <div class="text-[10px] text-gray-400 uppercase">VELOCITY</div>
                    <div class="text-xl font-mono-tech text-blue-300"><span id="sat-vel">0</span> <span class="text-xs text-gray-500">km/s</span></div>
                </div>
            </div>

            <div id="isro-badge" class="hidden mt-2 bg-white/10 border border-orange-500/30 rounded p-2 flex items-center gap-2">
                <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-bold text-orange-400">ISRO ASSET CONFIRMED</span>
            </div>
        </div>
    </div>

    <div class="absolute bottom-6 left-6 z-20 flex gap-4 pointer-events-auto">
        <div class="glass-panel px-5 py-3 rounded-lg flex flex-col min-w-[120px]">
            <span class="text-[10px] text-gray-400 font-bold tracking-wider">ACTIVE SATS</span>
            <span id="count-total" class="text-2xl font-mono-tech text-white">0</span>
        </div>
        <div class="glass-panel px-5 py-3 rounded-lg flex flex-col min-w-[120px] border-orange-500/30">
            <span class="text-[10px] text-orange-400 font-bold tracking-wider">ISRO FLEET</span>
            <div class="flex items-end gap-2">
                <span id="count-isro" class="text-2xl font-mono-tech text-orange-500">0</span>
                <span class="mb-1 block w-2 h-2 rounded-full bg-orange-500"></span>
            </div>
        </div>
    </div>

    <div id="canvas-container" class="absolute inset-0 z-0 bg-black cursor-crosshair"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. ROBUST FALLBACK DATA (ISRO HEAVY) ---
        // Guaranteed to load if the API fails.
        const FALLBACK_DATA = [
            {name: "ISS (ZARYA)", l1: "1 25544U 98067A   23326.71457006  .00014757  00000-0  26656-3 0  9993", l2: "2 25544  51.6416 138.8687 0005234 329.8476 160.0767 15.49841872426354"},
            {name: "INSAT-3D", l1: "1 39216U 13038A   23325.39969605 -.00000282  00000-0  00000-0 0  9996", l2: "2 39216   0.0631 310.8797 0003058 290.4905  76.9934  1.00273760 37651"},
            {name: "GSAT-30", l1: "1 45026U 20005A   23325.26384267 -.00000257  00000-0  00000-0 0  9990", l2: "2 45026   0.0381 298.5422 0002014 286.0468 182.2619  1.00271298 13958"},
            {name: "RISAT-1A (EOS-04)", l1: "1 51656U 22013A   23326.12345678  .00000123  00000-0  12345-4 0  9999", l2: "2 51656  97.9000 120.0000 0001000  90.0000 270.0000 14.80000000 12345"},
            {name: "CARTOSAT-2E", l1: "1 31789U 07026A   23325.11122233  .00000456  00000-0  67890-4 0  9998", l2: "2 31789  97.9145 150.3322 0001234  45.6789 314.3211 14.78901234 54321"},
            {name: "EOS-06 (OCEANSAT)", l1: "1 54361U 22158A   23326.88776655  .00000567  00000-0  56789-4 0  9997", l2: "2 54361  98.3456 167.8901 0004321 123.4567 234.5678 14.65432198 11223"}
        ];

        // CONFIG
        const CONFIG = {
            earthRadius: 6371,
            scale: 0.001,
            maxSatellites: 8000
        };

        // --- 2. SCENE SETUP ---
        const scene = new THREE.Scene();
        // Starfield background color (very dark blue-black)
        scene.fog = new THREE.FogExp2(0x020205, 0.025);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(16, 8, 16);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Cap at 2x for laptops
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // --- 3. EARTH & ATMOSPHERE ---
        const texLoader = new THREE.TextureLoader();
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        // Standard Earth
        const earthGeo = new THREE.SphereGeometry(6.371, 64, 64);
        const earthMat = new THREE.MeshPhongMaterial({
            map: texLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            specularMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            bumpMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            bumpScale: 0.05,
            specular: new THREE.Color(0x333333),
            shininess: 10
        });
        const earth = new THREE.Mesh(earthGeo, earthMat);
        earthGroup.add(earth);

        // Custom Atmosphere GLSL Shader
        const vertexShader = `
            varying vec3 vNormal;
            void main() {
                vNormal = normalize(normalMatrix * normal);
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `;
        const fragmentShader = `
            varying vec3 vNormal;
            void main() {
                float intensity = pow(0.6 - dot(vNormal, vec3(0, 0, 1.0)), 4.0);
                // ISRO Blue/Cyan glow
                gl_FragColor = vec4(0.2, 0.6, 1.0, 0.5) * intensity;
            }
        `;
        const atmoGeo = new THREE.SphereGeometry(6.371 + 0.2, 64, 64);
        const atmoMat = new THREE.ShaderMaterial({
            vertexShader,
            fragmentShader,
            blending: THREE.AdditiveBlending,
            side: THREE.BackSide,
            transparent: true
        });
        const atmosphere = new THREE.Mesh(atmoGeo, atmoMat);
        scene.add(atmosphere);

        // Lighting
        const sun = new THREE.DirectionalLight(0xffffff, 2.0);
        sun.position.set(10, 5, 10);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x111111)); // Dark ambient

        // Stars
        const starsGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(3000 * 3);
        for(let i=0; i<3000*3; i++) starPos[i] = (Math.random() - 0.5) * 400;
        starsGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starsGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.15, transparent: true, opacity: 0.8}));
        scene.add(stars);


        // --- 4. SATELLITE SYSTEM (POINT CLOUD) ---
        let satellites = [];
        let pointsSystem;
        const satGeometry = new THREE.BufferGeometry();
        
        // Arrays for GPU
        let positions, colors;
        
        // Helper: Check if ISRO
        const isISRO = (name) => {
            const n = name.toUpperCase();
            return n.includes("GSAT") || n.includes("INSAT") || n.includes("RISAT") || n.includes("EOS-") || n.includes("CARTOSAT") || n.includes("IRNSS") || n.includes("MICROSAT") || n.includes("OCEANSAT");
        };

        function initSatellites(data) {
            satellites = data;
            
            // Sort ISRO first to prioritize their rendering order/z-index slightly
            satellites.sort((a,b) => (b.isIsro ? 1 : 0) - (a.isIsro ? 1 : 0));

            const count = satellites.length;
            positions = new Float32Array(count * 3);
            colors = new Float32Array(count * 3);
            
            // Generate circular texture
            const circleMap = new THREE.TextureLoader().load("https://threejs.org/examples/textures/sprites/disc.png");

            satGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            satGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const mat = new THREE.PointsMaterial({
                size: 0.2,
                map: circleMap,
                vertexColors: true,
                alphaTest: 0.5,
                transparent: true,
                sizeAttenuation: true
            });

            pointsSystem = new THREE.Points(satGeometry, mat);
            scene.add(pointsSystem);
            
            // Update counts
            document.getElementById('count-total').innerText = count;
            document.getElementById('count-isro').innerText = satellites.filter(s => s.isIsro).length;
        }

        // --- 5. DATA FETCHING (Fail-Safe) ---
        async function loadData() {
            let parsed = [];
            
            // 1. Add Fallback first (immediate visuals)
            FALLBACK_DATA.forEach(d => {
                const rec = satellite.twoline2satrec(d.l1, d.l2);
                parsed.push({ rec, name: d.name, isIsro: true, id: "ISRO-00" });
            });

            // 2. Try Fetch
            try {
                // Using corsproxy to bypass local restriction
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle'));
                if(!res.ok) throw new Error("Network");
                
                const text = await res.text();
                const lines = text.split('\n');
                
                // Parse
                for(let i=0; i<lines.length; i++) {
                    const l = lines[i].trim();
                    if(l.startsWith('1 ') && lines[i+1]) {
                        const l1 = l;
                        const l2 = lines[i+1].trim();
                        let name = "UNKNOWN";
                        if(i>0 && !lines[i-1].startsWith('2 ')) name = lines[i-1].trim();

                        try {
                            const rec = satellite.twoline2satrec(l1, l2);
                            const satName = name;
                            parsed.push({
                                rec, 
                                name: satName, 
                                isIsro: isISRO(satName),
                                id: l2.split(' ')[1]
                            });
                        } catch(e) {}
                    }
                }
            } catch(e) {
                console.log("Using backup data only.");
            }
            
            // Slice to max for laptop performance
            initSatellites(parsed.slice(0, CONFIG.maxSatellites));
        }

        loadData();

        // --- 6. INTERACTION (RAYCASTING) ---
        const raycaster = new THREE.Raycaster();
        raycaster.params.Points.threshold = 0.2; // Hitbox size
        const mouse = new THREE.Vector2();
        let hoveredIdx = -1;

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        });

        // UI Helpers
        window.closePanel = () => {
            const p = document.getElementById('info-panel');
            p.classList.remove('translate-x-0', 'opacity-100');
            p.classList.add('translate-x-full', 'opacity-0');
        };

        function updatePanel(sat, dist) {
            const p = document.getElementById('info-panel');
            p.classList.remove('translate-x-full', 'opacity-0');
            p.classList.add('translate-x-0', 'opacity-100');
            
            document.getElementById('sat-name').innerText = sat.name;
            document.getElementById('sat-id').innerText = "NORAD ID: " + (sat.id || "N/A");
            
            // Alt: Distance from center minus earth radius
            const alt = Math.round(dist/CONFIG.scale - CONFIG.earthRadius);
            document.getElementById('sat-alt').innerText = alt;
            
            // Vel: Calculate velocity magnitude (approx)
            const v = Math.sqrt(sat.v.x**2 + sat.v.y**2 + sat.v.z**2);
            document.getElementById('sat-vel').innerText = v.toFixed(2);
            
            const badge = document.getElementById('isro-badge');
            if(sat.isIsro) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }

        // --- 7. ANIMATION LOOP ---
        const clock = new THREE.Clock();
        
        function animate() {
            requestAnimationFrame(animate);

            // Time
            const now = new Date();
            document.getElementById('clock-utc').innerText = now.toISOString().split('T')[1].split('.')[0];
            
            // Earth Rotation (GMST)
            const gmst = satellite.gstime(now);
            earthGroup.rotation.y = gmst;

            // Update Satellite Positions
            if(pointsSystem) {
                const positions = pointsSystem.geometry.attributes.position.array;
                const colors = pointsSystem.geometry.attributes.color.array;
                
                for(let i=0; i<satellites.length; i++) {
                    const sat = satellites[i];
                    const pv = satellite.propagate(sat.rec, now);
                    
                    if(pv.position && !isNaN(pv.position.x)) {
                        // Store V for UI
                        sat.v = pv.velocity;

                        // Coord Transform
                        const x = pv.position.x * CONFIG.scale;
                        const y = pv.position.z * CONFIG.scale; // Z->Y
                        const z = -pv.position.y * CONFIG.scale; // Y->-Z

                        positions[i*3] = x;
                        positions[i*3+1] = y;
                        positions[i*3+2] = z;

                        // Colors
                        if(i === hoveredIdx) {
                            colors[i*3] = 1.0; colors[i*3+1] = 1.0; colors[i*3+2] = 1.0; // White
                        } else if(sat.isIsro) {
                            colors[i*3] = 1.0; colors[i*3+1] = 0.6; colors[i*3+2] = 0.0; // Orange
                        } else {
                            colors[i*3] = 0.2; colors[i*3+1] = 0.5; colors[i*3+2] = 0.9; // Blue
                        }
                    } else {
                        positions[i*3] = 0;
                    }
                }
                pointsSystem.geometry.attributes.position.needsUpdate = true;
                pointsSystem.geometry.attributes.color.needsUpdate = true;
            }

            // Raycasting
            raycaster.setFromCamera(mouse, camera);
            if(pointsSystem) {
                const intersects = raycaster.intersectObject(pointsSystem);
                if(intersects.length > 0) {
                    const idx = intersects[0].index;
                    if(hoveredIdx !== idx) {
                        hoveredIdx = idx;
                        document.body.style.cursor = "pointer";
                        const sat = satellites[idx];
                        const dist = intersects[0].distance;
                        updatePanel(sat, dist);
                    }
                } else {
                    hoveredIdx = -1;
                    document.body.style.cursor = "crosshair";
                }
            }

            controls.update();
            renderer.render(scene, camera);
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>
