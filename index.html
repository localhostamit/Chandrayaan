<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISRO Orbital Monitor | Real-Time Tracking</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/5.0.0/satellite.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: 'Segoe UI', monospace; }
        
        /* Custom Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2.0); opacity: 0; }
        }
        .ping-ring::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            border: 1px solid #f97316; /* Orange */
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        /* Glassmorphism UI */
        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .isro-gradient {
            background: linear-gradient(90deg, #FF9933, #FFFFFF, #138808); /* India Flag Colors approx */
            height: 2px;
            width: 100%;
        }
    </style>
</head>
<body class="text-slate-200 antialiased selection:bg-orange-500 selection:text-white">

    <div class="absolute top-0 left-0 p-4 md:p-6 z-20 pointer-events-none flex items-start gap-4">
        <div class="bg-white/90 p-2 rounded-lg shadow-[0_0_20px_rgba(255,255,255,0.2)] pointer-events-auto">
            <img src="https://upload.wikimedia.org/wikipedia/commons/b/bd/Indian_Space_Research_Organisation_Logo.svg" 
                 alt="ISRO Logo" 
                 class="h-12 w-auto md:h-16">
        </div>
        
        <div class="mt-1">
            <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-white drop-shadow-md">
                MISSION<span class="text-orange-500">CONTROL</span>
            </h1>
            <div class="flex items-center gap-2 text-xs md:text-sm font-mono text-blue-300">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span>REAL-TIME TELEMETRY</span>
            </div>
        </div>
    </div>

    <div id="sat-card" class="absolute top-24 right-4 md:right-8 w-64 md:w-80 glass-panel rounded-xl overflow-hidden shadow-2xl transition-all duration-300 transform translate-x-full opacity-0 z-20 pointer-events-none">
        <div class="isro-gradient"></div>
        <div class="p-5">
            <div class="flex justify-between items-start mb-2">
                <h2 id="card-name" class="text-xl font-bold text-white truncate">SAT_NAME</h2>
                <span id="card-type" class="text-[10px] font-bold bg-blue-900 text-blue-200 px-2 py-1 rounded border border-blue-700">LEO</span>
            </div>
            
            <div class="space-y-3 mt-4 text-sm font-mono text-gray-300">
                <div class="flex justify-between border-b border-white/10 pb-1">
                    <span>NORAD ID</span>
                    <span id="card-id" class="text-white">00000</span>
                </div>
                <div class="flex justify-between border-b border-white/10 pb-1">
                    <span>ALTITUDE</span>
                    <span class="text-orange-400"><span id="card-alt">0</span> km</span>
                </div>
                <div class="flex justify-between border-b border-white/10 pb-1">
                    <span>VELOCITY</span>
                    <span class="text-white"><span id="card-vel">0</span> km/s</span>
                </div>
            </div>
            <div class="mt-4 text-[10px] text-gray-500">
                Data provided by CelesTrak (Public GP)
            </div>
        </div>
    </div>

    <div class="absolute bottom-0 w-full p-4 md:p-6 z-20 pointer-events-none flex justify-between items-end">
        <div class="glass-panel px-4 py-2 rounded-lg pointer-events-auto">
            <div class="grid grid-cols-2 gap-x-8 gap-y-1 text-xs font-mono">
                <div class="text-gray-400">TOTAL OBJECTS</div>
                <div id="stat-total" class="text-white font-bold text-right">0</div>
                <div class="text-orange-400">ISRO ASSETS</div>
                <div id="stat-isro" class="text-orange-400 font-bold text-right">0</div>
            </div>
        </div>

        <div class="text-right">
            <div id="clock" class="text-3xl md:text-5xl font-light text-white tracking-widest tabular-nums">00:00:00</div>
            <div class="text-xs text-blue-400 font-bold tracking-[0.3em] mt-1">UTC TIME STANDARD</div>
        </div>
    </div>

    <div id="canvas-container" class="w-full h-full cursor-crosshair"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- BACKUP DATA (ISRO HEAVY) ---
        // Pre-loaded data in case API fails, ensuring the map is never empty.
        const BACKUP_TLE = [
            // ISS
            {name:"ISS (ZARYA)",l1:"1 25544U 98067A   23326.71457006  .00014757  00000-0  26656-3 0  9993",l2:"2 25544  51.6416 138.8687 0005234 329.8476 160.0767 15.49841872426354"},
            // Chandrayaan-2 Orbiter (Approx data for vis)
            {name:"CHANDRAYAAN-2",l1:"1 44441U 19042A   23001.00000000  .00000000  00000-0  00000-0 0  9999",l2:"2 44441  90.0000   0.0000 0001000   0.0000   0.0000  0.05000000    1"},
            // Some EOS/GSAT (Example TLEs)
            {name:"EOS-04 (RISAT-1A)",l1:"1 51656U 22013A   23326.12345678  .00000123  00000-0  12345-4 0  9999",l2:"2 51656  97.9000 120.0000 0001000  90.0000 270.0000 14.80000000 12345"},
            {name:"GSAT-30",l1:"1 45026U 20005A   23326.55555555  .00000055  00000-0  55555-4 0  9999",l2:"2 45026   0.0500  83.0000 0003000   0.0000   0.0000  1.00270000 1234"},
        ];

        // CONFIG
        const CONFIG = {
            earthRadius: 6371,
            scale: 0.001, // 1 unit = 1000km
            maxPoints: 4000, // Limit for laptop performance
            colors: {
                default: new THREE.Color(0x3b82f6), // Blue
                isro: new THREE.Color(0xff8800),    // Orange
                selected: new THREE.Color(0xffffff)  // White
            }
        };

        // --- SCENE ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020205, 0.03); // Blend background

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(15, 8, 15);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio > 1 ? 2 : 1); // Limit pixel ratio for laptops
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // --- EARTH ---
        const texLoader = new THREE.TextureLoader();
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const earthMat = new THREE.MeshPhongMaterial({
            map: texLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
            specularMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-water.png'),
            bumpMap: texLoader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
            bumpScale: 0.02,
            specular: new THREE.Color(0x333333),
            shininess: 15
        });
        const earth = new THREE.Mesh(new THREE.SphereGeometry(6.371, 48, 48), earthMat);
        earthGroup.add(earth);

        // Atmosphere Glow
        const atmoMat = new THREE.ShaderMaterial({
            side: THREE.BackSide, transparent: true,
            uniforms: {},
            vertexShader: `varying vec3 vN;void main(){vN=normalize(normalMatrix*normal);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
            fragmentShader: `varying vec3 vN;void main(){float i=pow(0.6-dot(vN,vec3(0,0,1)),3.5);gl_FragColor=vec4(0.3,0.6,1.0,0.5)*i;}`
        });
        const atmo = new THREE.Mesh(new THREE.SphereGeometry(6.55, 48, 48), atmoMat);
        scene.add(atmo);

        // Lighting
        const sun = new THREE.DirectionalLight(0xffffff, 2.5);
        sun.position.set(20, 10, 10);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0x404040));

        // --- SATELLITE SYSTEM (POINTS) ---
        // Using THREE.Points is much faster than InstancedMesh for thousands of objects
        
        let satelliteData = [];
        let geometry = new THREE.BufferGeometry();
        let points = null;
        let positions, colors;
        
        function initPointSystem(count) {
            positions = new Float32Array(count * 3);
            colors = new Float32Array(count * 3);
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            // Custom texture for round soft dots
            const sprite = new THREE.TextureLoader().load( 'https://threejs.org/examples/textures/sprites/disc.png' );

            const material = new THREE.PointsMaterial({ 
                size: 0.25, 
                vertexColors: true, 
                map: sprite, 
                alphaTest: 0.5,
                transparent: true 
            });

            points = new THREE.Points(geometry, material);
            scene.add(points);
        }

        // --- DATA HANDLING ---
        function isISRO(name) {
            // Check known ISRO naming conventions
            const n = name.toUpperCase();
            return n.includes("GSAT") || n.includes("INSAT") || n.includes("RISAT") || n.includes("EOS-") || n.includes("CARTOSAT") || n.includes("CHANDRAYAAN") || n.includes("MANGALYAAN") || n.includes("PSLV");
        }

        async function loadData() {
            let parsedSats = [];

            // 1. Fetch
            try {
                // Using corsproxy to get public NORAD data
                const url = 'https://corsproxy.io/?' + encodeURIComponent('https://celestrak.org/NORAD/elements/gp.php?GROUP=active&FORMAT=tle');
                const res = await fetch(url);
                const text = await res.text();
                
                const lines = text.split('\n');
                for(let i=0; i<lines.length; i++) {
                    const line = lines[i].trim();
                    if(line.startsWith('1 ') && lines[i+1]) {
                        const l1 = line;
                        const l2 = lines[i+1].trim();
                        let name = "UNKNOWN";
                        if(i>0 && !lines[i-1].startsWith('2 ')) name = lines[i-1].trim();
                        
                        try {
                            const rec = satellite.twoline2satrec(l1, l2);
                            parsedSats.push({rec, name, isIsro: isISRO(name), id: l2.split(' ')[1]});
                        } catch(e){}
                    }
                }
            } catch(e) {
                console.warn("Using Backup Data");
                BACKUP_TLE.forEach(d => {
                    parsedSats.push({
                        rec: satellite.twoline2satrec(d.l1, d.l2),
                        name: d.name,
                        isIsro: true,
                        id: "BACKUP"
                    });
                });
            }

            // 2. Sort: Put ISRO satellites first so they render on top/are prioritized
            parsedSats.sort((a,b) => (b.isIsro ? 1 : 0) - (a.isIsro ? 1 : 0));

            // 3. Cap count for performance
            satelliteData = parsedSats.slice(0, CONFIG.maxPoints);

            // 4. Update UI Stats
            document.getElementById('stat-total').innerText = satelliteData.length;
            document.getElementById('stat-isro').innerText = satelliteData.filter(s => s.isIsro).length;

            // 5. Init System
            initPointSystem(satelliteData.length);
        }

        // --- INTERACTION (RAYCASTER) ---
        const raycaster = new THREE.Raycaster();
        raycaster.params.Points.threshold = 0.3; // Make it easier to click dots
        const mouse = new THREE.Vector2();
        
        let hoveredIndex = -1;

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        });

        // --- ANIMATION ---
        const clock = new THREE.Clock();
        
        function animate() {
            requestAnimationFrame(animate);
            
            const now = new Date();
            document.getElementById('clock').innerText = now.toISOString().split('T')[1].split('.')[0];
            
            // 1. Earth Rotation
            const gmst = satellite.gstime(now);
            earthGroup.rotation.y = gmst;

            // 2. Update Points
            const posAttr = geometry.attributes.position;
            const colAttr = geometry.attributes.color;

            for(let i=0; i<satelliteData.length; i++) {
                const sat = satelliteData[i];
                const pv = satellite.propagate(sat.rec, now);
                
                if(pv.position && !isNaN(pv.position.x)) {
                    // Coordinates: ECI (km) -> Three (units)
                    // Map ECI X->X, Z->Y, Y->-Z (Right Handed Y-up)
                    const x = pv.position.x * CONFIG.scale;
                    const y = pv.position.z * CONFIG.scale;
                    const z = -pv.position.y * CONFIG.scale;

                    posAttr.setXYZ(i, x, y, z);

                    // Color Logic
                    if(i === hoveredIndex) {
                        colAttr.setXYZ(i, 1, 1, 1); // White (Selected)
                    } else if(sat.isIsro) {
                        colAttr.setXYZ(i, 1, 0.5, 0); // Orange (ISRO)
                    } else {
                        // Fade distant/debris to dark blue
                        colAttr.setXYZ(i, 0.2, 0.4, 0.8); 
                    }
                } else {
                    // Hide invalid
                    posAttr.setXYZ(i, 0, 0, 0);
                }
            }
            
            posAttr.needsUpdate = true;
            colAttr.needsUpdate = true;

            // 3. Raycasting
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(points);

            if (intersects.length > 0) {
                const index = intersects[0].index;
                
                if (hoveredIndex !== index) {
                    hoveredIndex = index;
                    document.body.style.cursor = 'pointer';
                    showCard(satelliteData[index], intersects[0].point);
                }
            } else {
                if (hoveredIndex !== -1) {
                    hoveredIndex = -1;
                    document.body.style.cursor = 'crosshair';
                    hideCard();
                }
            }

            controls.update();
            renderer.render(scene, camera);
        }

        // --- UI FUNCTIONS ---
        const card = document.getElementById('sat-card');
        
        function showCard(sat, point3d) {
            // Update Text
            document.getElementById('card-name').innerText = sat.name;
            document.getElementById('card-id').innerText = sat.id || "N/A";
            
            // Calculate Altitude (approx magnitude - earth radius)
            // Note: point3d is scaled. 
            const dist = Math.sqrt(point3d.x**2 + point3d.y**2 + point3d.z**2);
            const alt = Math.round((dist / CONFIG.scale) - CONFIG.earthRadius);
            
            document.getElementById('card-alt').innerText = alt;
            
            // Show Card
            card.classList.remove('translate-x-full', 'opacity-0');
            
            // Stop rotation to focus
            controls.autoRotate = false;
        }

        function hideCard() {
            card.classList.add('translate-x-full', 'opacity-0');
            controls.autoRotate = true;
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start
        loadData();
        animate();

    </script>
</body>
</html>
